<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>使用strace工具故障排查的5种简单方法 | Linux系统管理</title>
  <meta name="author" content="wgzhao">
  
  <meta name="description" content="Linux,SA,DBA,bigdata">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="使用strace工具故障排查的5种简单方法"/>
  <meta property="og:site_name" content="Linux系统管理"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Linux系统管理" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  
</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">Linux系统管理</a></h1>
  <h2><a href="/">关注Linux系统管理，运维开发以及大数据</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2012-01-16T13:40:00.000Z"><a href="/2012/01/16/5-simple-ways-to-troubleshoot-using-strace/">1月 16 2012</a></time>
      
      
  
    <h1 class="title">使用strace工具故障排查的5种简单方法</h1>
  

    </header>
    <div class="entry">
      
        <p>本文源自<a href="http://www.hokstad.com/5-simple-ways-to-troubleshoot-using-strace.html" target="_blank">5 simple ways to troubleshoot using strace</a>，我做了一些摘译。  </p>
<p>strace 是一个非常简单的工具，用来跟踪可执行程序的系统调用 (system call)。最简单的使用是，它追踪可行程序运行时的整个生命周期，输出每一个系统调用的名字，参数和返回值。<br>但是它还可以做更多的事情：<br><a id="more"></a></p>
<ol>
<li>它可以基于系统调用或者系统调用组来过滤  </li>
<li>它可以通过计算制定系统调用的次数，花费的时间以及成功和失败的次数来描述系统调用的使用</li>
<li>它可以追踪发送给进程的信号 (signal)</li>
<li>它可以通过进程 id(pid) 号加入到任意正在运行的进程上</li>
</ol>
<h2 id=" 如何使用 ">如何使用</h2>
<p>这里只是简单的描述 strace 如何使用，并不打算对此做深入分析</p>
<ol>
<li><p><strong>找出一个程序启动时读取了哪个配置文件</strong>  </p>
<p> 有的时候，你发发现，无论你如何修改配置文件，应用程序并没有按照你的思路去运行，这是什么原因？一个浅显但容易忽视的考虑是，应用程序启动时读取了你认为要读取的配置文件了吗？看下面的例子：</p>
<pre><code> $ strace php <span class="number">2</span>&gt;&amp;<span class="number">1</span> | grep php.ini  
 open(<span class="string">"/usr/local/bin/php.ini"</span>, O_RDONLY) = -<span class="number">1</span> ENOENT (No such file or directory)  
 open(<span class="string">"/usr/local/lib/php.ini"</span>, O_RDONLY) = <span class="number">4</span>  
 lstat64(<span class="string">"/usr/local/lib/php.ini"</span>, {st_mode=S_IFLNK|<span class="number">0777</span>, st_size=<span class="number">27</span>,
 <span class="keyword">...</span>}) = <span class="number">0</span>  
 readlink(<span class="string">"/usr/local/lib/php.ini"</span>, <span class="string">"/usr/local/Zend/etc/php.ini"</span>,
 <span class="number">4096</span>) = <span class="number">27</span>  
 lstat64(<span class="string">"/usr/local/Zend/etc/php.ini"</span>, {st_mode=S_IFREG|<span class="number">0664</span>,st_size=<span class="number">40971</span>, <span class="keyword">...</span>}) = <span class="number">0</span>    
</code></pre><p> 上述 php 程序程序会首先从<code>/usr/local/bin/</code>下读取<code>php.ini</code>文件，也许不是你想的首先从<code>/usr/local/lib/</code>下读取。<br> 上述的输出会很多，我们甚至可以通过参数来指定只追踪我们关心的系统调用，类似如下：  </p>
<pre><code>  $ strace -e <span class="built_in">open</span> php <span class="number">2</span>&gt;&amp;<span class="number">1</span> | grep php.ini  
  <span class="built_in">open</span>(<span class="string">"/usr/local/bin/php.ini"</span>, O_RDONLY) = -<span class="number">1</span> ENOENT (No such <span class="built_in">file</span> <span class="operator">or</span>
  <span class="built_in">directory</span>)  
  <span class="built_in">open</span>(<span class="string">"/usr/local/lib/php.ini"</span>, O_RDONLY) = <span class="number">4</span>  
</code></pre></li>
<li><p><strong>为什么程序没有打开我的文件？</strong></p>
<p> 每一个可执行程序读取文件时，如果权限不够，则会遭拒绝。而如果文件找不到，也并不会报错，除非你在程序里设置了错误处理，So，如果程序没有读取我的文件，我该如何跟踪呢？  </p>
<pre><code> $ strace -e <span class="keyword">open</span>,access <span class="number">2</span>&gt;&amp;<span class="number">1</span> |<span class="keyword">grep</span> your-filename
</code></pre><p> 检查 open() 和 access() 系统调用的输出结果，看看是什么原因</p>
</li>
<li><p><strong>进程此刻正在做什么？</strong></p>
<p> 你的程序突然消耗了大量的 CPU，或者程序似乎被挂起了，那么我们通过进程的 pid 号看看此刻它正在做什么  </p>
<pre><code> root@dev:~# strace -p <span class="number">15427</span>  
  <span class="keyword">Process</span> <span class="number">15427</span> attached - interrupt <span class="keyword">to</span> quit  
  futex(<span class="number">0x402f4900</span>, FUTEX_WAIT, <span class="number">2</span>, <span class="keyword">NULL</span>  
  <span class="keyword">Process</span> <span class="number">15427</span> detached  
</code></pre><p> 通过跟踪，你知道程序挂起的原因是正在调用 futex()。</p>
</li>
<li><p><strong>程序的时间花在什么地方</strong></p>
<p> 你总是希望程序能够按照你的意愿去工作，也希望它能在正确的时间做正确的事情，甚至希望它是最优的，尽可能在程序运行的周期内，消耗的 90% 以上的资源都是在做需要做的事情，而不是简单的等待。也许，下面的这个指令可以帮上你的忙:  </p>
<pre><code> <span class="comment">root@dev:~#</span> <span class="comment">strace</span> <span class="literal">-</span><span class="comment">c</span> <span class="literal">-</span><span class="comment">p</span> <span class="comment">11084</span>
 <span class="comment">Process</span> <span class="comment">11084</span> <span class="comment">attached</span> <span class="literal">-</span> <span class="comment">interrupt</span> <span class="comment">to</span> <span class="comment">quit</span>
 <span class="comment">Process</span> <span class="comment">11084</span> <span class="comment">detached</span>
 <span class="comment">%</span> <span class="comment">time</span>     <span class="comment">seconds</span>  <span class="comment">usecs/call</span>     <span class="comment">calls</span>    <span class="comment">errors</span> <span class="comment">syscall</span>
 <span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span> <span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span> <span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span> <span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span> <span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span> <span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span>
  <span class="comment">94</span><span class="string">.</span><span class="comment">59</span>    <span class="comment">0</span><span class="string">.</span><span class="comment">001014</span>          <span class="comment">48</span>        <span class="comment">21</span>           <span class="comment">select</span>
   <span class="comment">2</span><span class="string">.</span><span class="comment">89</span>    <span class="comment">0</span><span class="string">.</span><span class="comment">000031</span>           <span class="comment">1</span>        <span class="comment">21</span>           <span class="comment">getppid</span>
   <span class="comment">2</span><span class="string">.</span><span class="comment">52</span>    <span class="comment">0</span><span class="string">.</span><span class="comment">000027</span>           <span class="comment">1</span>        <span class="comment">21</span>           <span class="comment">time</span>
 <span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span> <span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span> <span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span> <span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span> <span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span> <span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span>
 <span class="comment">100</span><span class="string">.</span><span class="comment">00</span>    <span class="comment">0</span><span class="string">.</span><span class="comment">001072</span>                    <span class="comment">63</span>           <span class="comment">total</span>
 <span class="comment">root@dev:~#</span> 
</code></pre><p> 如果你是跟踪的后台守护进程，可以通过上面的指令跟踪一段时间，然后按<code>ctrl+c</code>退出，strace 会根据获得信息描述出上面的结果。<br> 上述的例子说明当前进程 (postmaster) 最要的时间花在等待<code>select()</code>函数上，在每调用一次<code>select</code>函数后，它分别调用<code>getpid</code>函数和<code>time</code>函数.<br> 如果是非后台守护进程，那 strace 可以跟踪进程的开始至结束，类似下面这样：  </p>
<pre><code> <span class="comment">root@dev:~#</span> <span class="comment">strace</span> <span class="literal">-</span><span class="comment">c</span> &gt;<span class="comment">/dev/null</span> <span class="comment">ls</span>
 <span class="comment">%</span> <span class="comment">time</span>     <span class="comment">seconds</span>  <span class="comment">usecs/call</span>     <span class="comment">calls</span>    <span class="comment">errors</span> <span class="comment">syscall</span>
 <span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span> <span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span> <span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span> <span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span> <span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span> <span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span>
  <span class="comment">23</span><span class="string">.</span><span class="comment">62</span>    <span class="comment">0</span><span class="string">.</span><span class="comment">000205</span>         <span class="comment">103</span>         <span class="comment">2</span>           <span class="comment">getdents64</span>
  <span class="comment">18</span><span class="string">.</span><span class="comment">78</span>    <span class="comment">0</span><span class="string">.</span><span class="comment">000163</span>          <span class="comment">15</span>        <span class="comment">11</span>         <span class="comment">1</span> <span class="comment">open</span>
  <span class="comment">15</span><span class="string">.</span><span class="comment">09</span>    <span class="comment">0</span><span class="string">.</span><span class="comment">000131</span>          <span class="comment">19</span>         <span class="comment">7</span>           <span class="comment">read</span>
  <span class="comment">12</span><span class="string">.</span><span class="comment">79</span>    <span class="comment">0</span><span class="string">.</span><span class="comment">000111</span>           <span class="comment">7</span>        <span class="comment">16</span>           <span class="comment">old_mmap</span>
   <span class="comment">7</span><span class="string">.</span><span class="comment">03</span>    <span class="comment">0</span><span class="string">.</span><span class="comment">000061</span>           <span class="comment">6</span>        <span class="comment">11</span>           <span class="comment">close</span>
   <span class="comment">4</span><span class="string">.</span><span class="comment">84</span>    <span class="comment">0</span><span class="string">.</span><span class="comment">000042</span>          <span class="comment">11</span>         <span class="comment">4</span>           <span class="comment">munmap</span>
   <span class="comment">4</span><span class="string">.</span><span class="comment">84</span>    <span class="comment">0</span><span class="string">.</span><span class="comment">000042</span>          <span class="comment">11</span>         <span class="comment">4</span>           <span class="comment">mmap2</span>
   <span class="comment">4</span><span class="string">.</span><span class="comment">03</span>    <span class="comment">0</span><span class="string">.</span><span class="comment">000035</span>           <span class="comment">6</span>         <span class="comment">6</span>         <span class="comment">6</span> <span class="comment">access</span>
   <span class="comment">3</span><span class="string">.</span><span class="comment">80</span>    <span class="comment">0</span><span class="string">.</span><span class="comment">000033</span>           <span class="comment">3</span>        <span class="comment">11</span>           <span class="comment">fstat64</span>
   <span class="comment">1</span><span class="string">.</span><span class="comment">38</span>    <span class="comment">0</span><span class="string">.</span><span class="comment">000012</span>           <span class="comment">3</span>         <span class="comment">4</span>           <span class="comment">brk</span>
   <span class="comment">0</span><span class="string">.</span><span class="comment">92</span>    <span class="comment">0</span><span class="string">.</span><span class="comment">000008</span>           <span class="comment">3</span>         <span class="comment">3</span>         <span class="comment">3</span> <span class="comment">ioctl</span>
   <span class="comment">0</span><span class="string">.</span><span class="comment">69</span>    <span class="comment">0</span><span class="string">.</span><span class="comment">000006</span>           <span class="comment">6</span>         <span class="comment">1</span>           <span class="comment">uname</span>
   <span class="comment">0</span><span class="string">.</span><span class="comment">58</span>    <span class="comment">0</span><span class="string">.</span><span class="comment">000005</span>           <span class="comment">5</span>         <span class="comment">1</span>           <span class="comment">set_thread_area</span>
   <span class="comment">0</span><span class="string">.</span><span class="comment">35</span>    <span class="comment">0</span><span class="string">.</span><span class="comment">000003</span>           <span class="comment">3</span>         <span class="comment">1</span>           <span class="comment">write</span>
   <span class="comment">0</span><span class="string">.</span><span class="comment">35</span>    <span class="comment">0</span><span class="string">.</span><span class="comment">000003</span>           <span class="comment">3</span>         <span class="comment">1</span>           <span class="comment">rt_sigaction</span>
   <span class="comment">0</span><span class="string">.</span><span class="comment">35</span>    <span class="comment">0</span><span class="string">.</span><span class="comment">000003</span>           <span class="comment">3</span>         <span class="comment">1</span>           <span class="comment">fcntl64</span>
   <span class="comment">0</span><span class="string">.</span><span class="comment">23</span>    <span class="comment">0</span><span class="string">.</span><span class="comment">000002</span>           <span class="comment">2</span>         <span class="comment">1</span>           <span class="comment">getrlimit</span>
   <span class="comment">0</span><span class="string">.</span><span class="comment">23</span>    <span class="comment">0</span><span class="string">.</span><span class="comment">000002</span>           <span class="comment">2</span>         <span class="comment">1</span>           <span class="comment">set_tid_address</span>
   <span class="comment">0</span><span class="string">.</span><span class="comment">12</span>    <span class="comment">0</span><span class="string">.</span><span class="comment">000001</span>           <span class="comment">1</span>         <span class="comment">1</span>           <span class="comment">rt_sigprocmask</span>
 <span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span> <span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span> <span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span> <span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span> <span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span> <span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span>
 <span class="comment">100</span><span class="string">.</span><span class="comment">00</span>    <span class="comment">0</span><span class="string">.</span><span class="comment">000868</span>                    <span class="comment">87</span>        <span class="comment">10</span> <span class="comment">total</span>
</code></pre><p> <code>ls</code>程序大部分时间花在读取目录条目上面。</p>
</li>
<li><p><strong>为什么我不能连接到服务器？</strong></p>
<p> 调试进程不能连接到服务器是一个痛苦的事情，因为原因很多，比如 DNS 失效啦，连接被挂起啦，服务器返回异常数据啦，服务器本身异常啦，等等。一般网络调试方面，很多人会想到另外一个非常不错的工具—<a href="http://www.tcpdump.org/" target="_blank">tcpdump</a>。但它的参数太多了，而且你要从上百个连接进程中找出其中一个进程为什么不能连接恐怕是一件非常费力的工作。strace 其实也能在这种情景下帮上你的忙，它仅仅输出与系统调用相关的数据，从而可以让我们的注意力更集中。类似下面这样：  </p>
<pre><code> $ strace -e poll,select,connect,recvfrom,sendto nc www.news.com <span class="number">80</span>
 sendto(<span class="number">3</span>, <span class="string">"\24\0\0\0\26\0\1\3\255\373NH\0\0\0\0\0\0\0\0"</span>, <span class="number">20</span>, <span class="number">0</span>, {sa_family=AF_NETLINK, pid=<span class="number">0</span>, groups=<span class="number">00000000</span>}, <span class="number">12</span>) = <span class="number">20</span>
 connect(<span class="number">3</span>, {sa_family=AF_FILE, path=<span class="string">"/var/run/nscd/socket"</span>}, <span class="number">110</span>) = -<span class="number">1</span> ENOENT (No such file or directory)
 connect(<span class="number">3</span>, {sa_family=AF_FILE, path=<span class="string">"/var/run/nscd/socket"</span>}, <span class="number">110</span>) = -<span class="number">1</span> ENOENT (No such file or directory)
 connect(<span class="number">3</span>, {sa_family=AF_INET, sin_port=htons(<span class="number">53</span>), sin_addr=inet_addr(<span class="string">"62.30.112.39"</span>)}, <span class="number">28</span>) = <span class="number">0</span>
 poll([{fd=<span class="number">3</span>, events=POLLOUT, revents=POLLOUT}], <span class="number">1</span>, <span class="number">0</span>) = <span class="number">1</span>
 sendto(<span class="number">3</span>, <span class="string">"\213\321\1\0\0\1\0\0\0\0\0\0\3www\4news\3com\0\0\34\0\1"</span>, <span class="number">30</span>, MSG_NOSIGNAL, <span class="literal">NULL</span>, <span class="number">0</span>) = <span class="number">30</span>
 poll([{fd=<span class="number">3</span>, events=POLLIN, revents=POLLIN}], <span class="number">1</span>, <span class="number">5000</span>) = <span class="number">1</span>
 recvfrom(<span class="number">3</span>, <span class="string">"\213\321\201\200\0\1\0\1\0\1\0\0\3www\4news\3com\0\0\34\0\1\300\f"</span><span class="keyword">...</span>, <span class="number">1024</span>, <span class="number">0</span>, {sa_family=AF_INET, sin_port=htons(<span class="number">53</span>), sin_addr=inet_addr(<span class="string">"62.30.112.39"</span>)}, [<span class="number">16</span>]) = <span class="number">153</span>
 connect(<span class="number">3</span>, {sa_family=AF_INET, sin_port=htons(<span class="number">53</span>), sin_addr=inet_addr(<span class="string">"62.30.112.39"</span>)}, <span class="number">28</span>) = <span class="number">0</span>
 poll([{fd=<span class="number">3</span>, events=POLLOUT, revents=POLLOUT}], <span class="number">1</span>, <span class="number">0</span>) = <span class="number">1</span>
 sendto(<span class="number">3</span>, <span class="string">"k\374\1\0\0\1\0\0\0\0\0\0\3www\4news\3com\0\0\1\0\1"</span>, <span class="number">30</span>, MSG_NOSIGNAL, <span class="literal">NULL</span>, <span class="number">0</span>) = <span class="number">30</span>
 poll([{fd=<span class="number">3</span>, events=POLLIN, revents=POLLIN}], <span class="number">1</span>, <span class="number">5000</span>) = <span class="number">1</span>
 recvfrom(<span class="number">3</span>, <span class="string">"k\374\201\200\0\1\0\2\0\0\0\0\3www\4news\3com\0\0\1\0\1\300\f"</span><span class="keyword">...</span>, <span class="number">1024</span>, <span class="number">0</span>, {sa_family=AF_INET, sin_port=htons(<span class="number">53</span>), sin_addr=inet_addr(<span class="string">"62.30.112.39"</span>)}, [<span class="number">16</span>]) = <span class="number">106</span>
 connect(<span class="number">3</span>, {sa_family=AF_INET, sin_port=htons(<span class="number">53</span>), sin_addr=inet_addr(<span class="string">"62.30.112.39"</span>)}, <span class="number">28</span>) = <span class="number">0</span>
 poll([{fd=<span class="number">3</span>, events=POLLOUT, revents=POLLOUT}], <span class="number">1</span>, <span class="number">0</span>) = <span class="number">1</span>
 sendto(<span class="number">3</span>, <span class="string">"\\\2\1\0\0\1\0\0\0\0\0\0\3www\4news\3com\0\0\1\0\1"</span>, <span class="number">30</span>, MSG_NOSIGNAL, <span class="literal">NULL</span>, <span class="number">0</span>) = <span class="number">30</span>
 poll([{fd=<span class="number">3</span>, events=POLLIN, revents=POLLIN}], <span class="number">1</span>, <span class="number">5000</span>) = <span class="number">1</span>
 recvfrom(<span class="number">3</span>, <span class="string">"\\\2\201\200\0\1\0\2\0\0\0\0\3www\4news\3com\0\0\1\0\1\300\f"</span><span class="keyword">...</span>, <span class="number">1024</span>, <span class="number">0</span>, {sa_family=AF_INET, sin_port=htons(<span class="number">53</span>), sin_addr=inet_addr(<span class="string">"62.30.112.39"</span>)}, [<span class="number">16</span>]) = <span class="number">106</span>
 connect(<span class="number">3</span>, {sa_family=AF_INET, sin_port=htons(<span class="number">80</span>), sin_addr=inet_addr(<span class="string">"216.239.122.102"</span>)}, <span class="number">16</span>) = -<span class="number">1</span> EINPROGRESS (Operation now <span class="keyword">in</span> progress)
 select(<span class="number">4</span>, <span class="literal">NULL</span>, [<span class="number">3</span>], <span class="literal">NULL</span>, <span class="literal">NULL</span>)        = <span class="number">1</span> (out [<span class="number">3</span>])
</code></pre><p> 那么，上述的输出，说明进程发生了什么呢？<br> 注意到这个进程尝试连接<code>/var/run/nscd/socket</code>连接了吗？这意味着<code>nc</code>程序首先会去连接 NSCD- Name Service Cache Daemon - 它通常用于设置和 NIS，YP，LDAP 或者类似目录协议相关的域名查询配置上。在上述例子中，连接失败了。  </p>
<p> 接下来进程开始连接到 DNS，这点可以从<code>sin_port=htons(53)</code>输出可以看出。你可以看到，它接着做了一个<code>sendto()</code>的调用，发出了一个包含<code>www.news.com</code>信息的 DNS 包。然后读取返回的包数据，不知什么原因，它做了三次这样的尝试。一个可能的原因是<code>www.news.com</code>是一条 CNAME 记录。多次请求可能是<code>nc</code>程序处理的一种方式。  </p>
<p> 最后，它总算是发起了<code>connect()</code>操作，注意这个操作的返回结果是<code>EINPROGRESS</code>，这意味着这个连接是非阻塞式的，<code>nc</code>希望继续，于是它调用了<code>select()</code>。</p>
<p> 增加<code>read</code>,<code>write</code>调用到 strace 跟踪的系统调用列表里，可以让我们看到下面的一些结果：  </p>
<pre><code> <span class="built_in">read</span>(<span class="number">0</span>, <span class="string">"test\n"</span>, <span class="number">1024</span>)                 = <span class="number">5</span>
 <span class="built_in">write</span>(<span class="number">3</span>, <span class="string">"test\n"</span>, <span class="number">5</span>)                   = <span class="number">5</span>
 poll([{fd=<span class="number">3</span>, events=POLLIN, revents=POLLIN}, {fd=<span class="number">0</span>, events=POLLIN}], <span class="number">2</span>, -<span class="number">1</span>) = <span class="number">1</span>
 <span class="built_in">read</span>(<span class="number">3</span>, <span class="string">"</span>
</code></pre><p> 上述表示它从读取”test” + 标准输入的一行信息，然后写入网络连接，接着调用<code>poll</code>来等待回应，然后读取网络反馈的信息并写到标准输出。</p>
</li>
</ol>

      
    </div>
    <footer>
      
        
  
  <div class="categories">
    <a href="/categories/strace/">strace</a>, <a href="/categories/strace/sys call/">sys call</a>, <a href="/categories/strace/sys call/troubleshooting/">troubleshooting</a>
  </div>

        
        
  <div class="addthis addthis_toolbox addthis_default_style">
    
      <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
    
    
      <a class="addthis_button_tweet"></a>
    
    
      <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
    
    
      <a class="addthis_button_pinterest_pinit" pi:pinit:layout="horizontal"></a>
    
    <a class="addthis_counter addthis_pill_style"></a>
  </div>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js"></script>

      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


<section id="comment">
  <h1 class="title">留言</h1>

  
      <div id="fb-root"></div>
<script>
  (function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=null";
    fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'facebook-jssdk'));
</script>

<div class="fb-comments" data-href="http://wgzhao.com/2012/01/16/5-simple-ways-to-troubleshoot-using-strace/" data-num-posts="5" data-width="840" data-colorscheme="light"></div>
      
  
</section>

</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜索">
    <input type="hidden" name="q" value="site:wgzhao.com">
  </form>
</div>

  
<div class="widget tag">
  <h3 class="title">分类</h3>
  <ul class="entry">
  
    <li><a href="/categories/Linux技术/">Linux技术</a><small>152</small></li>
  
    <li><a href="/categories/WEB开发/">WEB开发</a><small>5</small></li>
  
    <li><a href="/categories/Linux技术/WEB开发/">WEB开发</a><small>1</small></li>
  
    <li><a href="/categories/lsb/init/">init</a><small>1</small></li>
  
    <li><a href="/categories/lsb/init/linux/">linux</a><small>1</small></li>
  
    <li><a href="/categories/lsb/">lsb</a><small>1</small></li>
  
    <li><a href="/categories/vsftp/mysql/">mysql</a><small>1</small></li>
  
    <li><a href="/categories/vsftp/mysql/pam_mysql/">pam_mysql</a><small>1</small></li>
  
    <li><a href="/categories/plan/">plan</a><small>1</small></li>
  
    <li><a href="/categories/strace/">strace</a><small>1</small></li>
  
    <li><a href="/categories/plan/summary/">summary</a><small>1</small></li>
  
    <li><a href="/categories/strace/sys call/">sys call</a><small>1</small></li>
  
    <li><a href="/categories/strace/sys call/troubleshooting/">troubleshooting</a><small>1</small></li>
  
    <li><a href="/categories/vsftp/">vsftp</a><small>1</small></li>
  
    <li><a href="/categories/我读我书/">我读我书</a><small>11</small></li>
  
    <li><a href="/categories/Linux技术/我读我书/">我读我书</a><small>5</small></li>
  
    <li><a href="/categories/技术技巧/">技术技巧</a><small>25</small></li>
  
    <li><a href="/categories/Linux技术/技术技巧/">技术技巧</a><small>4</small></li>
  
    <li><a href="/categories/数据库/">数据库</a><small>8</small></li>
  
    <li><a href="/categories/随心所想/">随心所想</a><small>111</small></li>
  
    <li><a href="/categories/我读我书/随心所想/">随心所想</a><small>1</small></li>
  
  </ul>
</div>


  
<div class="widget tag">
  <h3 class="title">最新文章</h3>
  <ul class="entry">
    
      <li>
        <a href="/2012/12/30/some-tips-for-mac-os-x/">一些Mac OS X 的使用技巧</a>
      </li>
    
      <li>
        <a href="/2012/08/24/generate-random-strings-and-other-tips-on-postgresql/">生成随机字符串以及自动更新时间戳和返回最近插入的ID号</a>
      </li>
    
      <li>
        <a href="/2012/08/22/some-way-to-io-statistics-on-linux/">Linux下的一些I/O统计工具</a>
      </li>
    
      <li>
        <a href="/2012/08/21/explaining-the-postgresql-query-optimizer/">PostgreSQL查询优化简介</a>
      </li>
    
      <li>
        <a href="/2012/08/20/several-popular-nosql-databases-key-features-list/">几种常见的NoSQL数据库关键特性列表</a>
      </li>
    
  </ul>
</div>


  
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/12">十二月 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/08">八月 2012</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/04">四月 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/01">一月 2012</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/09">九月 2011</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/08">八月 2011</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/04">四月 2011</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/03">三月 2011</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/08">八月 2010</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/07">七月 2010</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/06">六月 2010</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/05">五月 2010</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/04">四月 2010</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/03">三月 2010</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/02">二月 2010</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/01">一月 2010</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2009/12">十二月 2009</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2009/11">十一月 2009</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2009/10">十月 2009</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2009/09">九月 2009</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2009/08">八月 2009</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2009/07">七月 2009</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2009/04">四月 2009</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2009/03">三月 2009</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2009/02">二月 2009</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2009/01">一月 2009</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2008/12">十二月 2008</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2008/09">九月 2008</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2008/08">八月 2008</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2008/07">七月 2008</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2008/06">六月 2008</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2008/05">五月 2008</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2008/04">四月 2008</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2008/03">三月 2008</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2008/02">二月 2008</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2008/01">一月 2008</a><span class="archive-list-count">16</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2007/12">十二月 2007</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2007/11">十一月 2007</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2007/10">十月 2007</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2007/09">九月 2007</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2007/08">八月 2007</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2007/07">七月 2007</a><span class="archive-list-count">16</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2007/06">六月 2007</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2007/05">五月 2007</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2007/04">四月 2007</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2007/03">三月 2007</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2007/02">二月 2007</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2007/01">一月 2007</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2006/12">十二月 2006</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2006/11">十一月 2006</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2006/10">十月 2006</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2006/09">九月 2006</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2006/08">八月 2006</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2006/07">七月 2006</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2006/06">六月 2006</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2006/05">五月 2006</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2006/04">四月 2006</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2006/03">三月 2006</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2006/01">一月 2006</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2005/12">十二月 2005</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2005/11">十一月 2005</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2005/09">九月 2005</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2005/05">五月 2005</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2005/04">四月 2005</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2005/03">三月 2005</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2005/01">一月 2005</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2004/12">十二月 2004</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2004/10">十月 2004</a><span class="archive-list-count">3</span></li></ul>
    </div>
  </div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2014 wgzhao
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<script type="text/javascript">
var disqus_shortname = 'wgzhao';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>