
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Btrfs介绍及性能测试 - Linux系统管理</title>
  <meta name="author" content="wgzhao">

  
  <meta name="description" content="Linux 原生的 ext4 文件系统目前已经在一些最新的 Linux 发布版本中包含了，我也使用了一段时间，和 ext3 相比，有所改善但是不是那种非常显著的干劲，更详细的情况可以参考这篇文章(ext4 文件系统：介绍及性能测试)。不过我一直向往 Solaris 上的 ZFS， &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://wgzhao.github.io/2009/07/01/btrfs-introduction-and-benchmark">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Linux系统管理" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
div.entry-content > p, section > p, blockquote > p {text-indent: 2em;}
code {text-indent: 0em;}
div.entry-content > p:first-of-type {text-indent: 0em;}
div.entry-content > p:first-of-type:first-letter
  {font-size:180%;font-weight:bold;}

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Linux系统管理</a></h1>
  
    <h2>关注Linux系统管理，运维开发以及大数据</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com.hk/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:wgzhao.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Home</a></li>
  <li><a href="/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Btrfs介绍及性能测试</h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-07-01T00:00:00+08:00" pubdate data-updated="true"></time>
        
           | <a href="#disqus_thread"
             data-disqus-identifier="http://wgzhao.github.io">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>Linux 原生的 ext4 文件系统目前已经在一些最新的 Linux 发布版本中包含了，我也使用了一段时间，和 ext3 相比，有所改善但是不是那种非常显著的干劲，更详细的情况可以参考这篇文章(<a href="http://www.linux-mag.com/id/7271">ext4 文件系统：介绍及性能测试</a>)。不过我一直向往 <a href="http://www.oracle.com/cn/products/servers-storage/solaris/index.html">Solaris</a> 上的 <a href="http://docs.oracle.com/cd/E19253-01/819-7065/" title="ZFS">ZFS</a>，觉得那才是真正的企业级文件系统，COW,CDP 等功能让人着迷，虽然目前 linux 上已经有基于 <a href="http://fuse.sourceforge.net/">fuse</a> 的 <a href="http://docs.oracle.com/cd/E19253-01/819-7065/" title="ZFS">ZFS</a>实现，但是性能上就大打折扣了，直到 <a href="https://btrfs.wiki.kernel.org/" title="Btrfs">Btrfs</a>文件系统的出现，让我看到了未来：</p>

<p><a href="https://btrfs.wiki.kernel.org/" title="Btrfs">Btrfs</a> 承若将赋予这个文件系统许多类似 ZFS 的企业级特征，甚至在性能和亮点上要超过 <a href="http://docs.oracle.com/cd/E19253-01/819-7065/" title="ZFS">ZFS</a>。事实上，很多 Linux 专家认为 <a href="https://btrfs.wiki.kernel.org/" title="Btrfs">Btrfs</a>应该是 Linux 未来的 一个关键点。不过目前 <a href="https://btrfs.wiki.kernel.org/" title="Btrfs">Btrfs</a>目前还没有完全发布，不过相信很快大家就能用到了，在正式使用之前，我们不妨对它做一些了解，甚至可以对其进行一些性能上的测试。</p>

<!--more-->


<h2>Btrfs 文件系统介绍</h2>

<p><a href="https://btrfs.wiki.kernel.org/" title="Btrfs">Btrfs</a>，有时又被称作&#8221;Butter FS&#8221;(黄油文件系统？），最先由在 <a href="http://www.oracle.com" title="Oracle">Oracle</a>工作的 <a href="http://oss.oracle.com/~mason/">Chris Mason</a> 发起这个项目，<a href="http://www.oracle.com" title="Oracle">Oracle</a>以 <a href="http://www.gnu.org/copyleft/gpl.html" title="GNU General Public License">GPL</a>协议发布。目前这个项目在 Linux 社区获得大量的追随者并引起大多数人的共鸣，目前 <a href="https://btrfs.wiki.kernel.org/" title="Btrfs">Btrfs</a>有以下特性：</p>

<ul>
<li>写时复制(Copy on Write a.k.a COW)</li>
<li>扩展（extents,看和 <a href="http://www.linux-mag.com/id/7271">ext4</a> 有关文档）</li>
<li>针对小文件提升空间效率</li>
<li>针对目录索引提升空间效率</li>
<li>动态 i 节点分配</li>
<li>可写的快照(writable snapshot)</li>
<li>快照的快照(snapshots of snapshots)</li>
<li>子卷(subvolumes,根文件系统内部分割）</li>
<li>对象级镜像和条带化(object level mirroring and striping)</li>
<li>数据和元数据的校验和</li>
<li>压缩</li>
<li>集成多设备支持，包含几种 RAID 算法</li>
<li>在线文件系统检查和碎片整理</li>
<li>非常快速的离线文件系统检查</li>
<li>高效的增量备份和文件系统镜像</li>
</ul>


<p>从以上的特征，你能看出来 <a href="https://btrfs.wiki.kernel.org/" title="Btrfs">Btrfs</a>是一个非常有“野心”的项目，当然看了这些特征，估计你会爱死它了（不会像 <a href="http://zh.wikipedia.org/wiki/Multics">Multics</a> 一样不堪重负而死掉吧？）可能你立刻会问到一个问题，“和 <a href="http://docs.oracle.com/cd/E19253-01/819-7065/" title="ZFS">ZFS</a>相比如何？”，恩，知道你会问这个问题，因为有人已经有<a href="http://www.codestrom.com/wandering/2009/03/zfs-vs-[Btrfs]-comparison.html">非常长的文章</a>来对此作为比较，我们这里摘录其关键点吧，看下面这张对照表格：</p>

<table>
<tbody>
<tr>
<th>特征</th>
<th>ZFS</th>
<th>BTRFS</th>
</tr>
<tr>
<td>写时复制</td>
<td>是</td>
<td>是</td>
</tr>
<tr>
<td>快照</td>
<td>是</td>
<td>是</td>
</tr>
<tr>
<td>快照的快照</td>
<td>不清楚</td>
<td>是</td>
</tr>
<tr>
<td>磁盘使用率接近 98-100%时，性能受损</td>
<td>是</td>
<td>差不多是这样</td>
</tr>
<tr>
<td>块级别压缩</td>
<td>是</td>
<td>当前是作为一个挂载选项</td>
</tr>
<tr>
<td>磁盘加密</td>
<td>正在开发</td>
<td>已经计划了，但是目前还未进入内核，encryptfs 是一个选择</td>
</tr>
<tr>
<td>在线改变文件系统大小</td>
<td>否</td>
<td>是</td>
</tr>
<tr>
<td>在线碎片整理</td>
<td>否</td>
<td>是</td>
</tr>
<tr>
<td>写校验和</td>
<td>是</td>
<td>是</td>
</tr>
<tr>
<td>内建 RAID</td>
<td>是(0,1,10, 5 )</td>
<td>是(0, 1, 10)</td>
</tr>
<tr>
<td>ACL</td>
<td>是</td>
<td>是</td>
</tr>
<tr>
<td>直接 IO</td>
<td>是</td>
<td>写可以，读不行–已经计划了</td>
</tr>
<tr>
<td>配额</td>
<td>是</td>
<td>是</td>
</tr>
</tbody>
</table>


<h2>特性详解</h2>

<p><a href="https://btrfs.wiki.kernel.org/" title="Btrfs">Btrfs</a>是非常有雄心的一个项目，带来了非常多的新特性，一些非常重要和关键的特性已经在上面的列表中说了，这些特性值得我们深入了解。</p>

<h4>动态 i 节点分配这个特性听上去不怎么实用，实际上，在创建/扩展文件系统时，它还是很有用的。动态分配意味着当创建文件系统时只有少量的 i 节点被创建，当 i 节点不够时，文件系统会非常平滑的创建更多的 i 节点。想想以前创建一个 500G 的文件系统时，有多少时间是花在创建 i 节点上呢？</h4>

<h4>快照(snapshot)</h4>

<p><a href="https://btrfs.wiki.kernel.org/" title="Btrfs">Btrfs</a>允许你创建文件系统或者文件系统某一个部分的快照，你可以利用这个快照来创建备份，或者在紧急情况下的数据拷贝。你也可以使用它来将文件系统的某一个部分 dump 出来作为一个归档（归档后，你可以删除快照和原始数据）。通常，快照是不会被修改的，因为做快照一般都是用来执行一些比较关键的任务，比如备份、修复、归档等。但是在某些情况下，你可以需要对快照做一些写的操作，<a href="https://btrfs.wiki.kernel.org/" title="Btrfs">Btrfs</a>允许你这么干举个例子：假定你对某一个目录做了快照，而后你又在这个目录做了一些工作，只要你能确保这个目录已经更新到快照里，你就可以保持你的拷贝是最新的，这实际上是一个快照的快照，这就是 <a href="https://btrfs.wiki.kernel.org/" title="Btrfs">Btrfs</a>一个非常灵活的快照功能(没有明白？等你用了 <a href="https://btrfs.wiki.kernel.org/" title="Btrfs">Btrfs</a>，你就明白了）。</p>

<h4>写时复制(Copy on Write)</h4>

<p>这个术语已经听得很多了，它指的是允许你的某一些数据在写的时候被拷贝（就是做了两次拷贝）。在 <a href="https://btrfs.wiki.kernel.org/" title="Btrfs">Btrfs</a>里，这个技术可以有各种用途。比如 <a href="https://btrfs.wiki.kernel.org/" title="Btrfs">Btrfs</a>可以将它和快照甚至快照的快照技术联合起来使用，这样使得数据很容易更新。<br/>
<a href="https://btrfs.wiki.kernel.org/" title="Btrfs">Btrfs</a>也可以使用它来记录日至，比如对于日志文件系统，可以对日志或者数据来一个写时复制，这就可以保证数据的高可用性。</p>

<h4>子卷(Subvolumes)</h4>

<p><a href="https://btrfs.wiki.kernel.org/" title="Btrfs">Btrfs</a>能够把文件系统的某一部分分离出来挂载，就像是一个独立的文件系统一样。当你想限制用户访问一个目录中的某一个部分的时候，这个功能就会变得非常有用。比如，如果在一个主目录里，其中一个子目录希望能被用户访问，而其他部分不允许。那么这个子目录就可以当作子卷（subvolume）挂载，对用户而言，她就像一个实际的文件系统一样。</p>

<h4>多设备支持</h4>

<p>当前 Linux 系统，如果你想创建一个 RAID-0 或者 RAID-1 或者其他 RAID 级别，然后在这些设备用上 LVM，你可能需要使用硬件 RAID 卡或者软 RAID（md）来做到把多个设备合成一个虚拟的设备。而 <a href="https://btrfs.wiki.kernel.org/" title="Btrfs">Btrfs</a>则把对多设备(RAID)的支持内嵌到文件系统里了。当前，<a href="https://btrfs.wiki.kernel.org/" title="Btrfs">Btrfs</a>可以做 RAID-0，RAID-1，RAID-10（以后应该会增加系统 RAID 级别）。<br/>
<a href="https://btrfs.wiki.kernel.org/" title="Btrfs">Btrfs</a>一旦被创建，它允许你直接增加设备（磁盘）到这个文件系统里（动态 i 节点分配是关键），当然也允许你拿走设备。（哦，天啦，哦，天啦，天啦，这不就是一个磁盘阵列了么？）</p>

<h4>文件系统检查和碎片整理增强</h4>

<p>文件系统检查(fsck)对系统管理员而言就是一个毒药，因为做文件系统检查，你就需要将文件系统处于 offline 的状态（在线 fsck，你试试，别到时哭都没有地方哭去），然后做 fsck 操作来修复，这个过程是需要花费大量的时间的，修复完成后，你总算可以重新挂载了（假定你修复出来的文件系统没有问题）。<br/>
Btrfs 允许你对一个已经挂载而且在使用的文件系统进行在线的文件系统检查。在检查的过程中，你仍然可以使用这个文件系统。另外，虽然文件系统开发人员尽了最大的努力，但是碎片还是会发生，当然也就会影响性能（想起那个著名的有关 windows 磁盘碎片整理的笑话来了）。磁盘碎片整理也需要文件系统处于 offline 的状态，和 fsck 差不多，而 <a href="https://btrfs.wiki.kernel.org/" title="Btrfs">Btrfs</a>也允许你在在线的时候使用。</p>

<h4>加密</h4>

<p>文件系统加密变得越来越流行，特别对一些企业和敏感人士的笔记本而言，一旦笔记本被偷或者遇到不良维修人员（想象陈君冠希老师吧），也许你会死的很惨。因此文件系统加密变得很重要了。<br/>
<a href="https://btrfs.wiki.kernel.org/" title="Btrfs">Btrfs</a>加入了非常强的加密功能，而且还会提供一些额外的技术（记住：目前这部分还在开发过程中）</p>

<h4>压缩</h4>

<p>除了加密，<a href="https://btrfs.wiki.kernel.org/" title="Btrfs">Btrfs</a>也提供了压缩来节省空间和提升性能的功能，当前，它使用内核自带的 zlib 压缩算法。</p>

<h4>Btrfs，何时到来?</h4>

<p>一旦有新的功能，我们总是想问，我们嘛时候能使用呀？可是新功能总是要经过无数次的测试，调试，开发这样的一个迭代过程，因此不会来的太快的。</p>

<p>目前，内核 2.6.29 版本已经进入了 <a href="https://btrfs.wiki.kernel.org/" title="Btrfs">Btrfs</a>，不过加上了“试验(experimental)”的标签，这当然是 Linux 一贯的做法，可以获得更广泛的测试以及问题反馈。你可以升级到这个核心，并订阅 <a href="https://btrfs.wiki.kernel.org/" title="Btrfs">Btrfs</a>的开发邮件列表，为 <a href="https://btrfs.wiki.kernel.org/" title="Btrfs">Btrfs</a>的早日杀青作出你的贡献吧。</p>

<h2>创建 Btrfs 文件系统和测试说了这么多，都是干说，现在我们来点实际的，下面给出一个完整的 <a href="https://btrfs.wiki.kernel.org/" title="Btrfs">Btrfs</a>文件系统创建和测试的步骤，让大家过足瘾吧。故事从下面的指令开始：<code>%mkfs.btrfs /dev/sda1</code> 它发生的太快了，连你想掐秒表计算时间的机会都没有。OK，来个脚本测试一把吧：</h2>

<pre><code>[root@test64 ~]# ./test.sh
Sat Apr 18 15:47:50 EDT 2009

WARNING! - Btrfs Btrfs v0.18 IS EXPERIMENTAL
WARNING! - see http://btrfs.wiki.kernel.org before using

fs created label (null) on /dev/sda1
        nodesize 4096 leafsize 4096 sectorsize 4096 size 465.76GB
Btrfs Btrfs v0.18
Sat Apr 18 15:47:51 EDT 2009
</code></pre>

<p>不要不相信自己的眼睛，没错，465G 的文件系统创建只要 1 秒钟，这就是 i 节点动态分配的直接结果。你可以用创建 ext3 文件系统来作为一个对比(当然，ext4 已经支持 i 节点动态分配了）</p>

<p>创建完后,挂载当然是一件很简单的事情了。</p>

<pre><code>%mount -t btrfs /dev/sda1 /mnt/data_btrfs
</code></pre>

<p>在多个设备上创建文件系统也很简单，缺省情况下，在在多个设备上创建 <a href="https://btrfs.wiki.kernel.org/" title="Btrfs">Btrfs</a> 文件系统是，元数据(metadata)会在每一个设备上做一个镜像（类似 RAID1）。而数据而采取条带模式(类似 RAID0)。当然 <a href="https://btrfs.wiki.kernel.org/" title="Btrfs">Btrfs</a> 也允许你改变元数据存储的方式，它支持下面的方式：</p>

<ul>
<li>RAID-0 (元数据在每一个设备上都会有）</li>
<li>RAID-1 (元数据在每一个设备上都镜像）</li>
<li>RAID-10 (元数据在每一个设备上都有，而且相互镜像)</li>
<li>single (元数据存在单个设备上)</li>
</ul>


<p>下面是在多个设备上创建 <a href="https://btrfs.wiki.kernel.org/" title="Btrfs">Btrfs</a>的例子：</p>

<pre><code>% mkfs.btrfs /dev/sda1 /dev/sdb1
</code></pre>

<p>现在你可以使用/dev/sda1 或者/dev/sdb1 挂载。创建多设备的文件系统并不比创建单个设备的文件系统要慢。</p>

<h4>性能测试</h4>

<p>性能测试有很多，这里我们选择 iozone 工具，关于 <a href="http://www.iozone.org" title="iozone">iozone</a> 的相关说明和用户可以参考官方文档。测试环境是 AMD Opteron64 CPU 2.0GHz，CentOS 5.3,Btrfs v0.18，kernel 2.6.30-rc1</p>

<p>我们会针对单个磁盘和两个磁盘分别进行测试，对于挂载选项，我们可以选择了缺省（标准）挂载方式和以下的挂载参数：</p>

<ul>
<li>nodatacow (无写时复制）</li>
<li>nodatasum （无数据校验）</li>
<li>compress （打开数据压缩）</li>
</ul>


<p>下面的测试结果表有 4 列：write,rewrite,read,reread。作为对比，我们选择了 ext3(default),ext4(default),ext3(performance),ext4(performance)最为测试比较对象。详细情况请看下表：</p>

<table>
<tbody><tr>
<th><center>File System</center></th>
<th><center>mkfs.btrfs<br>options</center></th>
<th><center>Mount options</center></th>
<th><center>Write<br>MB/s</center></th>
<th><center>Rewrite<br>MB/s</center></th>
<th><center>Read<br>MB/s</center></th>
<th><center>Reread<br>MB/s</center></th>
</tr>
<tr align="right">
<td><center><i>Ext3</i></center></td>
<td><center></center></td>
<td><center></center></td>
<td>28.307</td>
<td>28.001</td>
<td>55.791</td>
<td>55.765</td>
</tr>
<tr align="right">
<td><center><i>Ext4</i></center></td>
<td><center></center></td>
<td><center></center></td>
<td>30.228</td>
<td>29.626</td>
<td>108.701</td>
<td>108.884</td>
</tr>
<tr align="right">
<td><center><i>Ext3 “optimal”</i></center></td>
<td><center></center></td>
<td><center></center></td>
<td>28.047</td>
<td>26.432</td>
<td>105.565</td>
<td>105.156</td>
</tr>
<tr align="right">
<td><center><i>Ext4 “optimal”</i></center></td>
<td><center></center></td>
<td><center></center></td>
<td>30.127</td>
<td>29.365</td>
<td>109.889</td>
<td>109.600</td>
</tr>
<tr align="right">
<td><center><i>Btrfs</i></center></td>
<td><center>Standard</center></td>
<td><center>Standard</center></td>
<td>31.586</td>
<td>31.917</td>
<td>104.104</td>
<td>104.106</td>
</tr>
<tr align="right">
<td><center><i>Btrfs</i></center></td>
<td><center>Standard</center></td>
<td><center>nodatacow,<br>nodatasum</center></td>
<td>31.933</td>
<td>31.839</td>
<td>107.157</td>
<td>106.565</td>
</tr>
<tr align="right">
<td><center><i>Btrfs</i></center></td>
<td><center>-m single</center></td>
<td><center>standard</center></td>
<td>31.513</td>
<td>31.504</td>
<td>105.578</td>
<td>105.828</td>
</tr>
<tr align="right">
<td><center><i>Btrfs</i></center></td>
<td><center>-m single</center></td>
<td><center>nodatacow,<br>nodatasum</center></td>
<td>31.874</td>
<td>31.896</td>
<td>105.109</td>
<td>106.565</td>
</tr>
<tr align="right">
<td><center><i>Btrfs</i></center></td>
<td><center>standard</center></td>
<td><center>compress</center></td>
<td>71.359</td>
<td>71.129</td>
<td>126.660</td>
<td>132.314</td>
</tr>
<tr align="right">
<td><center><i>Btrfs</i></center></td>
<td><center>two disks,<br>raid0</center></td>
<td><center>standard</center></td>
<td>49.891</td>
<td>50.318</td>
<td>129.907</td>
<td>132.024</td>
</tr>
<tr align="right">
<td><center><i>Btrfs</i></center></td>
<td><center>two disks,<br>raid0</center></td>
<td><center>nodatacow,<br>nodatasum</center></td>
<td>45.054</td>
<td>45.867</td>
<td>130.655</td>
<td>131.879</td>
</tr>
<tr align="right">
<td><center><i>Btrfs</i></center></td>
<td><center>two disks,<br>single</center></td>
<td><center>standard</center></td>
<td>50.144</td>
<td>50.264</td>
<td>126.984</td>
<td>131.130</td>
</tr>
<tr align="right">
<td><center><i>Btrfs</i></center></td>
<td><center>two disks,<br>single</center></td>
<td><center>nodatacow,<br>nodatasum</center></td>
<td>43.834</td>
<td>47.603</td>
<td>131.612</td>
<td>131.470</td>
</tr>
<tr align="right">
<td><center><i>Btrfs</i></center></td>
<td><center>two disks,<br>raid1</center></td>
<td><center>standard</center></td>
<td>48.984</td>
<td>50.388</td>
<td>122.818</td>
<td>109.867</td>
</tr>
<tr align="right">
<td><center><i>Btrfs</i></center></td>
<td><center>two disks,<br>raid1</center></td>
<td><center>nodatacow,<br>nodatasum</center></td>
<td>48.196</td>
<td>48.462</td>
<td>131.832</td>
<td>131.807</td>
</tr>
<tr align="right">
<td><center><i>Btrfs</i></center></td>
<td><center>two disks,<br>raid10</center></td>
<td><center>standard</center></td>
<td>49.859</td>
<td>50.101</td>
<td>130.655</td>
<td>132.179</td>
</tr>
<tr align="right">
<td><center><i>Btrfs</i></center></td>
<td><center>two disks,<br>raid10</center></td>
<td><center>nodatacow,<br>nodatasum</center></td>
<td>50.072</td>
<td>50.366</td>
<td>129.424</td>
<td>122.828</td>
</tr>
<tr align="right">
<td><center><i>Btrfs</i></center></td>
<td><center>-m single</center></td>
<td><center>-o compress</center></td>
<td>70.241</td>
<td>69.299</td>
<td>138.849</td>
<td>127.958</td>
</tr>
<tr align="right">
<td><center><i>Btrfs</i></center></td>
<td><center>-m single</center></td>
<td><center>-o compress<br>nodatacow,<br>nodatasum</center></td>
<td>31.976</td>
<td>31.922</td>
<td>107.000</td>
<td>106.728</td>
</tr>
<tr align="right">
<td><center><i>Btrfs</i></center></td>
<td><center>two disks,<br>raid0</center></td>
<td><center>-o compress</center></td>
<td>70.234</td>
<td>69.048</td>
<td>130.852</td>
<td>129928</td>
</tr>
<tr align="right">
<td><center><i>Btrfs</i></center></td>
<td><center>two disks,<br>raid0</center></td>
<td><center>-o compress<br>nodatacow,<br>nodatasum</center></td>
<td>48.762</td>
<td>48.831</td>
<td>130.812</td>
<td>130.202</td>
</tr>
<tr align="right">
<td><center><i>Btrfs</i></center></td>
<td><center>two disks,<br>raid1</center></td>
<td><center>-o compress</center></td>
<td>70.467</td>
<td>68.286</td>
<td>130.990</td>
<td>130.051</td>
</tr>
<tr align="right">
<td><center><i>Btrfs</i></center></td>
<td><center>two disks,<br>raid10</center></td>
<td><center>-o compress</center></td>
<td>70.900</td>
<td>69.926</td>
<td>130.812</td>
<td>130.202</td>
</tr>
</tbody></table>


<h4>性能测试结果分析</h4>

<p>从上面的测试结果，我们可以获得以下一些结论：</p>

<ul>
<li>Btrfs 的缺省挂载方式获得了和 ext4 相近的性能，相比 ext3 要好很多了</li>
<li>关闭数据校验和写时复制功能，性能有了显著提高，牺牲了数据的而外保护当然要在性能上获得补偿嘛</li>
<li>打开压缩选项后，性能相比标准挂载有了很大的提升，write 和 rewrite 差不多提升了 100%，而 read 和 reread 性能提升了 30%的样子。</li>
<li>使用两块磁盘时，通用 write 和 rewrite 性能提升 50%，write 和 rewrite 性能提升 30%。有意思的是，带压缩的单个磁盘 write 和 rewrite 性能比两个磁盘的性能要高。而且，带压缩的单个磁盘 read 和 reread 性能和两块磁盘的性能相当。</li>
<li>打开压缩和写时复制，关闭数据校验的情况下，write 和 rewrite 性能显著下降&mdash;大约 30%。然而，read 和 reread 性能没有太多影响。这说明这个特定的测试表明，数据校验这个性能更多的受 CPU 的影响而不是磁盘性能。</li>
</ul>


<p>以上测试结论或者在你的环境中有些不同，毕竟其影响因素太多，但是不管如何，对于一个还在开发过程中的文件系统而言，<a href="https://btrfs.wiki.kernel.org/" title="Btrfs">Btrfs</a>已经有了非常可观的性能。而且，针对单个磁盘，当压缩选项打开后，iozone 的测试性能是非常显著的。</p>

<h2>小结</h2>

<p>尽管 Linux 的开发和进展都非常好，但是还有一些人很早以前就要求 Linux 能够提供更好的文件系统，他们希望它具有企业级特性，而能和 <a href="http://docs.oracle.com/cd/E19253-01/819-7065/" title="ZFS">ZFS</a>竞争。<a href="https://btrfs.wiki.kernel.org/" title="Btrfs">Btrfs</a>应该回答和满足了这些人的需求。<a href="https://btrfs.wiki.kernel.org/" title="Btrfs">Btrfs</a>在内核 2.6.29 时合并到了内核主干里，不过目前仍然是试验性质的。并不是上述所有的特性都已经实现了，但是目前的版本(v0.18)已经有了非常多的特性了。</p>

<p>尽管在 CentOS 5.3 系统(kernel 2.6.30-rc1)里，<a href="https://btrfs.wiki.kernel.org/" title="Btrfs">Btrfs</a>还是试验性质，不过 <a href="https://btrfs.wiki.kernel.org/" title="Btrfs">Btrfs</a>的基本性能已经和 ext4 差不多了。综合上面的测试案例，<a href="https://btrfs.wiki.kernel.org/" title="Btrfs">Btrfs</a>的性能更多的受磁盘性能的影响，有时受 CPU 性能的影响（在使用压缩的测试例子里）。你当然还可以更加深入的研究上述的测试结果，以获得更多的信息。</p>

<p>如果你看了这篇文章，对 Btrfs 甚至 Linux 产生了浓厚的兴趣，那我会非常高兴的。</p>

<p>注：以上内容大部分内容翻译自 <a href="http://www.linux-mag.com/id/7308">Linux Don’t Need No Stinkin’ ZFS: BTRFS Intro &amp; Benchmarks</a>，另外一部分内容加入了自己的看法和理解。</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">wgzhao</span></span>

      








  


<time datetime="2009-07-01T00:00:00+08:00" pubdate data-updated="true"></time>
      

<span class="categories">
  
    <a class='category' href='//categories/linuxji-zhu/'>Linux技术</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://wgzhao.github.io/2009/07/01/btrfs-introduction-and-benchmark/" data-via="mlsx" data-counturl="http://wgzhao.github.io/2009/07/01/btrfs-introduction-and-benchmark/" >Tweet</a>
  
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/2009/04/24/have-bought-house/" title="Previous Post: 从此做一个快乐的房奴">&laquo; 从此做一个快乐的房奴</a>
      
      
        <a class="basic-alignment right" href="/2009/07/09/convert-virtualbox-vdi-to-kvm-qcow/" title="Next Post: 将virtualbox的vdi镜像文件转换成kvm的qcow静像文件">将virtualbox的vdi镜像文件转换成kvm的qcow静像文件 &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2014/03/16/move-to-github/">Move to Github</a>
      </li>
    
      <li class="post">
        <a href="/2012/12/30/some-tips-for-mac-os-x/">一些Mac OS X 的使用技巧</a>
      </li>
    
      <li class="post">
        <a href="/2012/08/24/generate-random-strings-and-other-tips-on-postgresql/">生成随机字符串以及自动更新时间戳和返回最近插入的ID号</a>
      </li>
    
      <li class="post">
        <a href="/2012/08/22/some-way-to-io-statistics-on-linux/">Linux下的一些I/O统计工具</a>
      </li>
    
      <li class="post">
        <a href="/2012/08/21/explaining-the-postgresql-query-optimizer/">PostgreSQL查询优化简介</a>
      </li>
    
  </ul>
</section>
<section>
<h1>QR-Code</h1>
<a href="/2009/07/01/btrfs-introduction-and-benchmark/"><img src="http://chart.apis.google.com/chart?chs=150x150&cht=qr&chld=|0&chco=165B94&chl=/2009/07/01/btrfs-introduction-and-benchmark/" alt="post-qrcode"></a></section>
<section>
  <h1>Categories</h1>
    <ul id="category-list"><li><a href='//categories/linuxji-zhu/'>Linux技术 (151)</a></li><li><a href='//categories/webkai-fa/'>WEB开发 (6)</a></li><li><a href='//categories/wo-du-wo-shu/'>我读我书 (16)</a></li><li><a href='//categories/ji-zhu-ji-qiao/'>技术技巧 (29)</a></li><li><a href='//categories/shu-ju-ku/'>数据库 (8)</a></li><li><a href='//categories/sui-xin-suo-xiang/'>随心所想 (113)</a></li></ul>
</section>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - wgzhao -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'wgzhao';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://wgzhao.github.io/2009/07/01/btrfs-introduction-and-benchmark/';
        var disqus_url = 'http://wgzhao.github.io/2009/07/01/btrfs-introduction-and-benchmark/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
