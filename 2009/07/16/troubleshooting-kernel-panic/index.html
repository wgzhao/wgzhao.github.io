
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Kernel Panic故障排解 - Linux系统管理</title>
  <meta name="author" content="wgzhao">

  
  <meta name="description" content="Linux kernel panic 是很难定位和排查的重大故障,一旦系统发生了kernel panic，相关的日志信息非常少，而一种常见的排查方法—重现法&mdash;又很难实现，因此遇到kernel panic的问题，一般比较头疼。 没有一个万能和完美的方法来解决所有的kernel &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://wgzhao.github.io/2009/07/16/troubleshooting-kernel-panic">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Linux系统管理" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Linux系统管理</a></h1>
  
    <h2>关注Linux系统管理，运维开发以及大数据</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com.hk/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:wgzhao.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Kernel Panic故障排解</h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-07-16T00:00:00+08:00" pubdate data-updated="true"></time>
        
           | <a href="#disqus_thread"
             data-disqus-identifier="http://wgzhao.github.io">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p><strong>Linux kernel panic</strong> 是很难定位和排查的重大故障,一旦系统发生了kernel panic，相关的日志信息非常少，而一种常见的排查方法—重现法&mdash;又很难实现，因此遇到kernel panic的问题，一般比较头疼。</p>

<p>没有一个万能和完美的方法来解决所有的kernel panic问题，这篇文章仅仅只是给出一些思路，一来如何解决kernel panic的问题，二来可以尽可能减少发生kernel panic的机会。</p>

<!--more-->


<h2>什么是kernel panic</h2>

<p>就像名字所暗示的那样，它表示Linux kernel走到了一个不知道该怎么走下一步的状况，一旦到这个情况，kernel就尽可能把它此时能获取的全部信息都打印出来，至于能打印出多少信息，那就看是那种情况导致它panic了。</p>

<p>有两种主要类型 kernel panic：</p>

<ol>
<li>hard panic(也就是Aieee信息输出)</li>
<li>soft panic (也就是Oops信息输出)</li>
</ol>


<h2>什么能导致kernel panic</h2>

<p>只有加载到内核空间的驱动模块才能直接导致kernel panic，你可以在系统正常的情况下，使用lsmod查看当前系统加载了哪些模块。 <br/>
除此之外，内建在内核里的组件（比如memory map等）也能导致panic。 <br/>
因为hard panic和soft panic本质上不同，因此我们分别讨论。 *</p>

<h2>如何排查hard panic</h2>

<p>一般出现下面的情况，就认为是发生了kernel panic:</p>

<ol>
<li>机器彻底被锁定，不能使用</li>
<li>数字键(Num Lock)，大写锁定键(Caps Lock)，滚动锁定键(Scroll Lock)不停闪烁。</li>
<li>如果在终端下，应该可以看到内核dump出来的信息（包括一段”Aieee”信息或者”Oops”信息）</li>
<li>和Windows蓝屏相似</li>
</ol>


<h3>原因：</h3>

<p>对于hard panic而言，最大的可能性是驱动模块的中断处理(interrupt handler)导致的，一般是因为驱动模块在中断处理程序中访问一个空指针(null pointre)。一旦发生这种情况，驱动模块就无法处理新的中断请求，最终导致系统崩溃。</p>

<h3>信息收集</h3>

<p>根据panic的状态不同，内核将记录所有在系统锁定之前的信息。因为kenrel panic是一种很严重的错误，不能确定系统能记录多少信息，下面是一些需要收集的关键信息，他们非常重要，因此尽可能收集全，当然如果系统启动的时候就kernel panic，那就无法只知道能收集到多少有用的信息了。</p>

<ol>
<li>/var/log/messages: 幸运的时候，整个kernel panic栈跟踪信息都能记录在这里。</li>
<li>应用程序/库 日志: 可能可以从这些日志信息里能看到发生panic之前发生了什么。</li>
<li>其他发生panic之前的信息，或者知道如何重现panic那一刻的状态</li>
<li>终端屏幕dump信息，一般OS被锁定后，复制，粘贴肯定是没戏了，因此这类信息，你可以需要借助数码相机或者原始的纸笔工具了。</li>
</ol>


<p>如果kernel dump信息既没有在/var/log/message里，也没有在屏幕上，那么尝试下面的方法来获取（当然是在还没有死机的情况下）：</p>

<ol>
<li>如果在图形界面，切换到终端界面，dump信息是不会出现在图形界面的，甚至都不会在图形模式下的虚拟终端里。</li>
<li><p>确保屏幕不黑屏，可以使用下面的几个方法：</p>

<ul>
<li>setterm -blank 0</li>
<li>setterm -powerdown 0</li>
<li>setvesablank off</li>
</ul>
</li>
<li><p>从终端，拷贝屏幕信息（方法见上）</p></li>
</ol>


<h3>完整栈跟踪信息的排查方法</h3>

<p>栈跟踪信息(stack trace)是排查kernel panic最重要的信息，该信息如果在<code>/var/log/messages</code>日志里当然最好，因为可以看到全部的信息，如果仅仅只是在屏幕上，那么最上面的信息可能因为滚屏消失了，只剩下栈跟踪信息的一部分。如果你有一个完整栈跟踪信息的话，那么就可能根据这些充分的信息来定位panic的根本原因。要确认是否有一个足够的栈跟踪信息，你只要查找包含”<em>EIP</em>”的一行，它显示了是什么函数和模块调用时导致panic。大概就像下面这个例子一样：</p>

<pre><code>Dec 20 02:40:58 AS-4 kernel: Unable to handle kernel NULL pointer dereference at virtual address 0000000c
Dec 20 02:40:58 AS-4 kernel: printing eip:
Dec 20 02:40:58 AS-4 kernel: f890c2c0 ###my comments: (in user_hold)                              
Dec 20 02:40:58 AS-4 kernel: *pde = 00000000
Dec 20 02:40:58 AS-4 kernel: Oops: 0002
Dec 20 02:40:58 AS-4 kernel: CPU:    3
Dec 20 02:40:58 AS-4 kernel: EIP:    0010:[&lt;f890c2c0&gt;]    Not tainted
Dec 20 02:40:58 AS-4 kernel: EFLAGS: 00010282
Dec 20 02:40:58 AS-4 kernel: eax: 00000000   ebx: ef27a5e8   ecx: 00000000   edx: c3036000
Dec 20 02:40:58 AS-4 kernel: esi: f5f31054   edi: f6109800   ebp: f5f31054   esp: c3037de4
Dec 20 02:40:58 AS-4 kernel: ds: 0018   es: 0018   ss: 0018
Dec 20 02:40:58 AS-4 kernel: Process swapper (pid: 0, stackpage=c3037000)
Dec 20 02:40:58 AS-4 kernel: Stack: f89269f2 f6109800 00000000 f5f31054 f5f31054 f6109800 f8926525 f6109800
Dec 20 02:40:58 AS-4 kernel: ef27a5e8 f5f31054 f5f31054 00000001 f8925c42 f5f31054 f6109800 f8925b42
Dec 20 02:40:58 AS-4 kernel: f5f31054 00000001 ef27a5e8 f89263ea f5f31054 f5f31054 f5f31054 f6f2c03c
Dec 20 02:40:58 AS-4 kernel: Call Trace: [&lt;f89269f2&gt;] [&lt;f8926525&gt;] [&lt;f8925c42&gt;] [&lt;f8925b42&gt;] [&lt;f89263ea&gt;]
Dec 20 02:40:58 AS-4 kernel: [&lt;f89261ce&gt;] [&lt;f8925c3a&gt;] [&lt;f8925b42&gt;] [&lt;f890879f&gt;] [&lt;f8908203&gt;] [&lt;c027175f&gt;]
Dec 20 02:40:58 AS-4 kernel: [&lt;f89513dc&gt;] [&lt;c0271841&gt;] [&lt;c0271966&gt;] [&lt;c0128b1b&gt;] [&lt;c0109400&gt;] [&lt;c0109521&gt;]
Dec 20 02:40:58 AS-4 kernel: [&lt;c01053cc&gt;] [&lt;c010b75f&gt;] [&lt;c01053cc&gt;] [&lt;c01053f5&gt;] [&lt;c0105445&gt;] [&lt;c0122c65&gt;]
Dec 20 02:40:58 AS-4 kernel:
Dec 20 02:40:58 AS-4 kernel: Code: f0 ff 40 0c c3 8d 76 00 53 8b 54 24 0c f0 ff 4a 0c 0f 94 c0
Dec 20 02:40:58 AS-4 kernel: &lt;0&gt;Kernel panic: Aiee, killing interrupt handler!
</code></pre>

<h2>完整栈信息无效的排查方法</h2>

<p>如果只有部分跟踪信息，要快速定位问题的根本原因就变得很难，因为没有明显的信息来告诉我们是哪个模块或者函数的调用导致了内核panic，你可能只能看到kernel最后的一些指令。这种情况下，要尽可能多的收集信息，包括程序日志，库的跟踪信息，故障重现的步骤等。</p>

<p>Hard panic 部分跟踪信息例子（没有EIP信息）：</p>

<pre><code>[c01e42e7] iprcv 
[kernel] 0x357 [f8a179d5] sramintr 
[streamsdlgnDriver] 0x32d [f89a3999] lisspinlockirqsavefcn 
[streams] 0x7d  [f8a82fdc] inthwlock
[streamsdlgnDriver] 0x1c [f8a7bad8] pwswtbl 
[streamsdlgnDriver] 0x0 [f8a15442] dlgnintr 
[streamsdlgnDriver] 0x4b [f8a7c30a] GnMaxpm 
[streamsdlgnDriver] 0x7ae [c0123bc1] runtimers
[kernel] 0xd1 [c0108a6e] handleIRQevent 
[kernel] 0x5e [c0108c74] doIRQ 
[kernel] 0xa4 [c0105410] defaultidle 
[kernel] 0x0 [c0105410] defaultidle 
[kernel] 0x0 [c022fab0] calldoIRQ
[kernel] 0x5 [c0105410] defaultidle 
[kernel] 0x0 [c0105410] defaultidle 
[kernel] 0x0 [c010543d] defaultidle 
[kernel] 0x2d [c01054c2] cpuidle 
[kernel] 0x2d [c011bb86] callconsoledrivers 
[kernel] 0x4b [c011bcfb] callconsoledrivers 
[kernel] 0xeb Code: 8b 50 0c 85 d2 74 31 f6 42 0a
02 74 04 89 44 24 08 31 f6 0f &lt;0&gt; 
Kernel panic: Aiee, killing interrupt handler! In interrupt handler - not syncing
</code></pre>

<h2>使用内核调试工具(kenrel debugger ,aka KDB)</h2>

<p>如果跟踪信息只有一部分且不足以用来定位问题的根本原因时，kernel debugger(KDB)就需要请出来了。
KDB编译到内核里，panic发生时，他将内核引导到一个shell环境而不是锁定。<br/>
这样，我们就可以收集一些与panic相关的信息了，这对我们定位问题的根本原因有很大的帮助。</p>

<p>使用KDB需要注意，内核必须是基本核心版本，比如是2.4.18，而不是2.4.18-5这样子的，因为KDB仅对基本核心有效。</p>

<h2>如何排查soft panic</h2>

<p><strong>症状：</strong></p>

<ol>
<li>没有hard panic严重</li>
<li>通常导致段错误(segmentation fault)</li>
<li>可以看到一个oops信息，/var/log/messages里可以搜索到&#8217;Oops&#8217;</li>
<li>机器稍微还能用（但是收集信息后，应该重启系统）</li>
</ol>


<p><strong>原因：</strong></p>

<p>凡是非中断处理引发的模块崩溃都将导致soft panic。<br/>
在这种情况下，驱动本身会崩溃，但是还不至于让系统出现致命性失败，因为它没有锁定中断处理例程。导致hard panic的原因同样对soft panic也有用（比如在运行时访问一个空指针)</p>

<p><strong>信息收集：</strong>
当soft panic发生时，内核将产生一个包含内核符号(kernel symbols)信息的dump数据，这个将记录在<code>/var/log/messages</code>里。<br/>
为了开始排查故障，可以使用ksymoops工具来把内核符号信息转成有意义的数据。</p>

<p>为了生成ksymoops文件,需要：</p>

<ul>
<li>从/var/log/messages里找到的堆栈跟踪文本信息保存为一个新文件。确保删除了时间戳(timestamp)，否则ksymoops会失败。</li>
<li>运行ksymoops程序（如果没有，请安装）</li>
<li>详细的ksymoops执行用法，可以参考ksymoops(8)手册。</li>
</ul>


<p>下面是一个soft panic的oops跟踪例子：</p>

<pre><code>Code: 8b 70 0c 50 e8 69 f9 f8 ff 83 c4 10 83 f8 08 74 35 66 c7 47 EIP; 
f89ba71e [streams-dlgnDriver]dlgnsetidlestate+1e/8c Trace; 
f8951bd6 [streams]liswakeupclose+86/110 Trace; 
f8a2705c [streams-dlgnDriver]moduleparmr4feature+280/1453 Trace;
f8a27040 [streams-dlgnDriver]moduleparmr4feature+264/1453 Trace; 
f89b9198 [streams-dlgnDriver]dlgnwput+e8/204 Trace;
</code></pre>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">wgzhao</span></span>

      








  


<time datetime="2009-07-16T00:00:00+08:00" pubdate data-updated="true"></time>
      

<span class="categories">
  
    <a class='category' href='//categories/linuxji-zhu/'>Linux技术</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://wgzhao.github.io/2009/07/16/troubleshooting-kernel-panic/" data-via="mlsx" data-counturl="http://wgzhao.github.io/2009/07/16/troubleshooting-kernel-panic/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/2009/07/10/fs-cache-and-cachefs-for-network-filesystem/" title="Previous Post: fs-cache and cachefs for network filesystem">&laquo; fs-cache and cachefs for network filesystem</a>
      
      
        <a class="basic-alignment right" href="/2009/07/22/recover-deleted-files-on-ext3-filesystem/" title="Next Post: 恢复ext3文件系统上被删除的文件">恢复ext3文件系统上被删除的文件 &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2014/03/16/move-to-github/">Move to Github</a>
      </li>
    
      <li class="post">
        <a href="/2012/12/30/some-tips-for-mac-os-x/">一些Mac OS X 的使用技巧</a>
      </li>
    
      <li class="post">
        <a href="/2012/08/24/generate-random-strings-and-other-tips-on-postgresql/">生成随机字符串以及自动更新时间戳和返回最近插入的ID号</a>
      </li>
    
      <li class="post">
        <a href="/2012/08/22/some-way-to-io-statistics-on-linux/">Linux下的一些I/O统计工具</a>
      </li>
    
      <li class="post">
        <a href="/2012/08/21/explaining-the-postgresql-query-optimizer/">PostgreSQL查询优化简介</a>
      </li>
    
  </ul>
</section>
<section>
<h1>QR-Code<abbr title="The word 'QR Code' is a registered trademark of DENSO WAVE INCORPORATED. It applies only for the word 'QR Code', not for image.">&trade;</abbr></h1>
<a href="http://wgzhao.github.io/2009/07/16/troubleshooting-kernel-panic/"><img src="http://chart.apis.google.com/chart?chs=150x150&cht=qr&chld=|0&chco=165B94&chl=http://wgzhao.github.io/2009/07/16/troubleshooting-kernel-panic/" alt="post-qrcode"></a></section>
<section>
  <h1>Categories</h1>
    <ul id="category-list"><li><a href='//categories/linuxji-zhu/'>Linux技术 (151)</a></li><li><a href='//categories/webkai-fa/'>WEB开发 (6)</a></li><li><a href='//categories/wo-du-wo-shu/'>我读我书 (16)</a></li><li><a href='//categories/ji-zhu-ji-qiao/'>技术技巧 (29)</a></li><li><a href='//categories/shu-ju-ku/'>数据库 (8)</a></li><li><a href='//categories/sui-xin-suo-xiang/'>随心所想 (113)</a></li></ul>
</section>
<section>
  <h1>Tag Cloud</h1>
    <span id="tag-cloud"><a href='//categories/linuxji-zhu' style='font-size: 160.0%'>Linux技术(151)</a> <a href='//categories/webkai-fa' style='font-size: 102.3841059602649%'>WEB开发(6)</a> <a href='//categories/wo-du-wo-shu' style='font-size: 106.35761589403974%'>我读我书(16)</a> <a href='//categories/ji-zhu-ji-qiao' style='font-size: 111.52317880794702%'>技术技巧(29)</a> <a href='//categories/shu-ju-ku' style='font-size: 103.17880794701986%'>数据库(8)</a> <a href='//categories/sui-xin-suo-xiang' style='font-size: 144.90066225165563%'>随心所想(113)</a> </span>
</section>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - wgzhao -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'wgzhao';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://wgzhao.github.io/2009/07/16/troubleshooting-kernel-panic/';
        var disqus_url = 'http://wgzhao.github.io/2009/07/16/troubleshooting-kernel-panic/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
